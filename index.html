<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lector Barcode Seguro</title>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 12px; color:#111; }
    h1 { font-size:18px; text-align:center; }
    video { width:100%; max-width:640px; border-radius:8px; background:#000; display:block; margin:auto; }
    #controls { margin-top:10px; text-align:center; }
    #result { margin-top:12px; font-weight:700; color:#1b5e20; text-align:center; }
    #status { font-size:13px; color:#555; text-align:center; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ðŸ“· Lector de CÃ³digos Seguro</h1>

  <video id="video" playsinline autoplay muted></video>

  <div id="controls">
    <button id="btnStart">Iniciar escaneo</button>
    <button id="btnStop">Detener</button>
  </div>

  <div id="result">CÃ³digo: <span id="codeValue">â€”</span></div>
  <div id="status">Estado: inactivo</div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzrJvR8YKhv4xlNmKmgcQ0A11bfqZq9EHqctrSJyIYgBkYbjp0bxCibo88nYYxj6xHTdw/exec";
    const SECRET_TOKEN = "MiTokenUltraSeguro123"; // cambia este valor tambiÃ©n en Code.gs

    const codeReader = new ZXing.BrowserBarcodeReader();
    const codeValue = document.getElementById("codeValue");
    const statusEl = document.getElementById("status");

    let scanning = false;

    function normalizeCode(raw) {
      return raw ? raw.replace(/[^0-9A-Za-z]/g,'').toUpperCase() : '';
    }

    function isValidCode(code) {
      return (/^G9[0-9A-Z]{10}$/.test(code) || /^G7[0-9A-Z]{10}$/.test(code));
    }

    async function startScanner() {
      scanning = true;
      statusEl.innerText = "Estado: iniciando cÃ¡mara...";
      codeReader.reset();
      try {
        await codeReader.decodeFromConstraints(
          { video: { facingMode: { exact: "environment" } } },
          'video',
          (result, err) => {
            if (result) {
              const raw = result.text;
              const cleaned = normalizeCode(raw);
              if (isValidCode(cleaned)) {
                codeValue.innerText = cleaned;
                statusEl.innerText = "CÃ³digo vÃ¡lido detectado, enviando...";
                sendToWebApp(cleaned);
                stopScanner();
              } else {
                statusEl.innerText = "Lectura invÃ¡lida";
              }
            }
          }
        );
        statusEl.innerText = "Estado: escaneando...";
      } catch(e) {
        console.error(e);
        statusEl.innerText = "Error al iniciar cÃ¡mara";
      }
    }

    function stopScanner() {
      scanning = false;
      codeReader.reset();
      statusEl.innerText = "Estado: detenido";
    }

    async function sendToWebApp(code) {
      try {
        const resp = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: SECRET_TOKEN, action: "create_folder", code: code })
        });
        console.log(await resp.text());
      } catch (err) {
        console.error("Error al enviar:", err);
      }
    }

    document.getElementById("btnStart").addEventListener("click", startScanner);
    document.getElementById("btnStop").addEventListener("click", stopScanner);
  </script>
</body>
</html>
