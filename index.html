<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector - Flujo Final</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<style>
  body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:12px; color:#111}
  header{display:flex;align-items:center;gap:12px}
  header img{height:56px}
  #videoWrap{position:relative;max-width:820px;margin:12px auto;background:#000;border-radius:8px;overflow:hidden}
  video{width:100%;height:auto;display:block}
  .overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
  #scanArea{position:absolute;border:3px dashed rgba(0,150,255,0.9);background:rgba(0,150,255,0.06);pointer-events:auto;cursor:move}
  .handle{position:absolute;width:14px;height:14px;background:#0096ff;right:-7px;bottom:-7px;border-radius:2px;cursor:se-resize}
  #controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  button, select{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
  button[disabled]{background:#eee;cursor:not-allowed;color:#999}
  #confirmBox{display:none;text-align:center;margin-top:12px}
  #accessories{display:none;text-align:center;margin-top:12px}
  .tagBtn{margin:6px;padding:8px 10px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
  .tagBtn.selected{background:#e6f7ff;border-color:#0096ff}
  #thumb{max-width:260px;display:block;margin:10px auto;border:1px solid #ddd;border-radius:6px}
  #status{margin-top:10px;text-align:center;color:#333}
</style>
</head>
<body>
<header><img src="logo.png" alt="logo"/><div><h2 style="margin:0">Lector & Uploader</h2><div style="font-size:13px;color:#555">Valida códigos G9/G7 (12 chars)</div></div></header>

<div id="videoWrap">
  <video id="video" playsinline autoplay muted></video>
  <div class="overlay">
    <div id="scanArea" style="left:20%;top:30%;width:60%;height:20%;">
      <div class="handle"></div>
    </div>
  </div>
</div>

<div id="controls">
  <label>Cámara: <select id="videoSelect"></select></label>
  <button id="btnRestart">Reiniciar</button>
  <button id="btnOCR">OCR</button>
  <button id="btnManual" disabled>Editar manual</button>
  <button id="btnConfirm" disabled>Confirmar y crear carpeta</button>
</div>

<div id="confirmBox">
  <p>Código detectado: <strong id="detectedCode">—</strong></p>
  <input id="manualInput" style="width:220px;padding:8px;border:1px solid #ccc;border-radius:6px" />
  <div style="margin-top:8px">
    <button id="confirmYes">Confirmar</button>
    <button id="confirmRetry">Reintentar</button>
  </div>
</div>

<img id="thumb" alt="foto" style="display:none"/>

<div id="accessories">
  <p>Seleccione accesorio y tome la foto</p>
  <div id="tags"></div>
  <div style="margin-top:8px">
    <button id="btnTake">Tomar foto</button>
    <button id="btnDone">Terminar</button>
  </div>
</div>

<div id="status">Estado: iniciando...</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzrJvR8YKhv4xlNmKmgcQ0A11bfqZq9EHqctrSJyIYgBkYbjp0bxCibo88nYYxj6xHTdw/exec1";
const SECRET_TOKEN = "MiTokenUltraSeguro123";
const DRIVE_PARENT_ID = "1lhyyCwOxzA9Mr6jUFScDTsOrXBLM7RRp";

const video = document.getElementById('video');
const videoSelect = document.getElementById('videoSelect');
const scanArea = document.getElementById('scanArea');
const btnRestart = document.getElementById('btnRestart');
const btnOCR = document.getElementById('btnOCR');
const btnManual = document.getElementById('btnManual');
const btnConfirm = document.getElementById('btnConfirm');
const confirmBox = document.getElementById('confirmBox');
const detectedCodeEl = document.getElementById('detectedCode');
const manualInput = document.getElementById('manualInput');
const thumb = document.getElementById('thumb');
const statusEl = document.getElementById('status');
const accessories = document.getElementById('accessories');
const tagsDiv = document.getElementById('tags');
const btnTake = document.getElementById('btnTake');
const btnDone = document.getElementById('btnDone');
const btnOCRel = document.getElementById('btnOCR');

const TAGS = ["Dispositivo","Arnés","Botón de pánico","IMEI cámara","Cámara frontal","Cámara trasera","Vehículo delantero","Vehículo trasero","Tablero","Tablero final"];

let selectedTag = TAGS[0];
let currentCode = null;
let photoCounter = 0;

const codeReader = new ZXing.BrowserBarcodeReader();

function normalizeCode(raw){ return raw? raw.replace(/[^0-9A-Za-z]/g,'').toUpperCase():''; }
function isValidCode(code){ return /^G9[0-9A-Z]{10}$/.test(code) || /^G7[0-9A-Z]{10}$/.test(code); }

function captureAreaDataURL(){
  const rect = scanArea.getBoundingClientRect();
  const vw = video.getBoundingClientRect();
  const scaleX = video.videoWidth / vw.width;
  const scaleY = video.videoHeight / vw.height;
  const sx = (rect.left - vw.left) * scaleX;
  const sy = (rect.top - vw.top) * scaleY;
  const sw = rect.width * scaleX;
  const sh = rect.height * scaleY;
  const canvas = document.createElement('canvas');
  canvas.width = Math.max(1,Math.floor(sw)); canvas.height = Math.max(1,Math.floor(sh));
  canvas.getContext('2d').drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg',0.9);
}

function captureFullDataURL(){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg',0.9);
}

async function sendToWebApp(payload){
  payload.token = SECRET_TOKEN;
  payload.parentFolderId = DRIVE_PARENT_ID;
  try{
    const r = await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const text = await r.text();
    console.log('webapp:',text);
    return text;
  }catch(e){ console.error(e); statusEl.innerText='Error envío'; return null; }
}

// populate tags UI
TAGS.forEach(t=>{
  const b=document.createElement('button');
  b.textContent=t; b.className='tagBtn'+(t===selectedTag?' selected':'');
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tagBtn').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected'); selectedTag=t;
  });
  tagsDiv.appendChild(b);
});

// draggable + resizable scanArea
(function makeDraggable(el){
  let dragging=false,resizing=false,startX,startY,startW,startH,startL,startT;
  const handle = el.querySelector('.handle');
  handle.addEventListener('pointerdown', e=>{ resizing=true; startX=e.clientX; startY=e.clientY; const r=el.getBoundingClientRect(); startW=r.width; startH=r.height; e.preventDefault(); });
  el.addEventListener('pointerdown', e=>{ if(e.target===handle) return; dragging=true; startX=e.clientX; startY=e.clientY; const r=el.getBoundingClientRect(); startL=r.left; startT=r.top; e.preventDefault(); });
  window.addEventListener('pointermove', e=>{
    if(!dragging && !resizing) return;
    const parent=document.getElementById('videoWrap').getBoundingClientRect();
    if(resizing){ const dx=e.clientX-startX, dy=e.clientY-startY; el.style.width=Math.max(40,startW+dx)+'px'; el.style.height=Math.max(30,startH+dy)+'px'; }
    else if(dragging){ const dx=e.clientX-startX, dy=e.clientY-startY; el.style.left=Math.min(Math.max(0,startL+dx-parent.left), parent.width-el.offsetWidth)+'px'; el.style.top=Math.min(Math.max(0,startT+dy-parent.top), parent.height-el.offsetHeight)+'px'; }
  });
  window.addEventListener('pointerup', ()=>{ dragging=false; resizing=false; });
})(scanArea);

// scanner callback
function onResult(result){
  if(!result || !result.text) return;
  const cleaned = normalizeCode(result.text);
  if(isValidCode(cleaned)){
    detectedCodeEl.textContent = cleaned;
    manualInput.value = cleaned;
    confirmBox.style.display='block';
    btnConfirm.disabled = false;
    btnManual.disabled = false;
    // capture preview thumb
    thumb.src = captureAreaDataURL(); thumb.style.display='block';
    statusEl.textContent = 'Lectura detectada - confirmar';
    // stop continuous scanning (but keep camera running)
    codeReader.reset();
  } else {
    statusEl.textContent = 'Lectura inválida';
  }
}

// start scanner
async function startScanner(deviceId=null){
  statusEl.textContent='Iniciando cámara...';
  btnConfirm.disabled = true; btnManual.disabled = true;
  try{
    await codeReader.decodeFromConstraints({video:{facingMode:{ideal:'environment'}}},'video',(result,err)=>{ if(result) onResult(result); });
    statusEl.textContent='Escaneando...';
  }catch(e){ console.error(e); statusEl.textContent='Error cámara'; }
}

// OCR option: read text in area with a simple canvas -> send to webapp could use tesseract but omitted to keep lightweight
btnOCR.addEventListener('click', async ()=>{
  statusEl.textContent='OCR (capturando área)...';
  const data = captureAreaDataURL();
  // If you want, you can integrate Tesseract here to read printed numbers
  // For now we show preview and allow manual edit
  thumb.src = data; thumb.style.display='block';
  statusEl.textContent='OCR: preview capturado - corrige si es necesario';
  confirmBox.style.display='block';
  manualInput.value = detectedCodeEl.textContent || '';
  btnConfirm.disabled = false; btnManual.disabled = false;
});

// manual edit opens confirm box
btnManual.addEventListener('click', ()=>{ confirmBox.style.display='block'; manualInput.focus(); });

// confirm flow: user confirms value and app creates folder and saves etiqueta.jpg
document.getElementById('confirmYes').addEventListener('click', async ()=>{
  const final = normalizeCode(manualInput.value||detectedCodeEl.textContent);
  if(!isValidCode(final)){ alert('Código inválido'); return; }
  currentCode = final;
  statusEl.textContent='Creando carpeta y subiendo etiqueta...';
  // create folder and upload etiqueta.jpg
  const photo = captureAreaDataURL();
  const resp = await sendToWebApp({action:'create_folder', code:currentCode, photo:photo});
  if(resp && resp.indexOf('Folder created')!==-1){
    statusEl.textContent='Carpeta creada: '+currentCode;
    confirmBox.style.display='none';
    accessories.style.display='block';
    photoCounter = 0;
  } else {
    statusEl.textContent='Error creando carpeta. Revisar permisos.';
    alert('No se pudo crear la carpeta. Revisa que el Web App esté desplegado y el token sea correcto.');
  }
});

document.getElementById('confirmRetry').addEventListener('click', ()=>{ confirmBox.style.display='none'; startScanner(); });

// take accessory photo
btnTake.addEventListener('click', async ()=>{
  if(!currentCode){ alert('Primero confirma el código'); return; }
  photoCounter++;
  const data = captureFullDataURL();
  // filename sequential: 1.jpg,2.jpg...
  const filename = photoCounter + '.jpg';
  statusEl.textContent = 'Subiendo '+filename+' ('+selectedTag+')...';
  await sendToWebApp({action:'upload_photo', code:currentCode, photo:data, filename:filename, tag:selectedTag});
  statusEl.textContent = filename + ' subida';
});

btnDone.addEventListener('click', ()=>{ accessories.style.display='none'; statusEl.textContent='Flujo finalizado'; });

// initialize devices list and start
async function listDevices(){
  try{
    const devices = await codeReader.listVideoInputDevices();
    videoSelect.innerHTML='';
    devices.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.text = d.label || 'Camera'; videoSelect.appendChild(o); });
    if(devices.length){
      const preferred = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[devices.length-1];
      videoSelect.value = preferred.deviceId;
    }
    videoSelect.addEventListener('change', ()=>{
      codeReader.reset();
      startScanner(videoSelect.value);
    });
    // start with camera
    await startScanner();
  }catch(e){ console.error(e); statusEl.textContent='No devices'; }
}

listDevices();
</script>
</body>
</html>
